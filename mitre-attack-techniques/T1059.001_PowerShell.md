# T1059.001: PowerShell

### Summary

Adversaries use PowerShell to execute scripts and commands as part of their attack chain. Because PowerShell is a legitimate and powerful system administration tool installed by default on all modern Windows systems, it is a prime target for abuse (a "living-off-the-land" binary, or LOLBin).

### How It's Used by Adversaries

-   **Fileless Malware:** Executing malicious payloads directly in memory without writing to disk.
-   **Reconnaissance:** Gathering information about the system, network, and users (e.g., `Get-Process`, `Get-NetTCPConnection`).
-   **Lateral Movement:** Moving to other systems on the network, often using PowerShell Remoting or by executing commands on remote shares.
-   **Credential Theft:** Using frameworks like `Mimikatz` (often injected via PowerShell) to dump credentials from memory.
-   **Obfuscation:** PowerShell has powerful obfuscation capabilities (e.g., Base64 encoding, string manipulation) that adversaries use to hide their commands from simple signature-based detection.

### What to Look For (Detection)

-   Monitor process execution for `powershell.exe`.
-   Look for suspicious command-line arguments, such as `-EncodedCommand`, `-e`, `-enc` (Base64 encoded commands), `-NonI` (NonInteractive), `-W Hidden` (hidden window style).
-   Enable and collect PowerShell Script Block Logging (Event ID 4104) and Module Logging (Event ID 4103). These logs capture the de-obfuscated script content, providing full visibility into what was executed.
-   Monitor for network connections originating from `powershell.exe`.
-   Look for parent-child process relationships, such as Microsoft Word spawning `powershell.exe`, which is highly suspicious.

### Recommended PowerShell Logging Configurations

To effectively detect and investigate PowerShell abuse, robust logging is essential. The following configurations should be deployed via Group Policy or equivalent management tools:

-   **Module Logging (Event ID 4103):** Records pipeline execution details as PowerShell modules are used. This includes parts of scripts, functions, and commands. This log often captures de-obfuscated script content, providing visibility into what was actually executed.
    -   **GPO Path:** Computer Configuration > Administrative Templates > Windows Components > Windows PowerShell > Turn on Module Logging
    -   **Setting:** Enable, and specify modules to log (e.g., `*` for all modules, or specific modules like `Microsoft.PowerShell.*`, `Microsoft.PowerShell.Utility`).
-   **Script Block Logging (Event ID 4104):** Captures the content of script blocks as they are executed, including obfuscated code before de-obfuscation and the de-obfuscated code itself. This is critical for understanding what malicious scripts are attempting to do.
    -   **GPO Path:** Computer Configuration > Administrative Templates > Windows Components > Windows PowerShell > Turn on PowerShell Script Block Logging
    -   **Setting:** Enable.
-   **Transcription (Event ID 4105, 4106):** Records all input and output of PowerShell sessions, essentially creating a transcript of every command executed. While verbose, it provides a complete record of user interaction with PowerShell.
    -   **GPO Path:** Computer Configuration > Administrative Templates > Windows Components > Windows PowerShell > Turn on PowerShell Transcription
    -   **Setting:** Enable, and configure a central logging path.
-   **System-Wide Transcripts:**
    -   **GPO Path:** Computer Configuration > Administrative Templates > Windows Components > Windows PowerShell > Turn on PowerShell Transcription > **Output directory for PowerShell Transcripts**.
    -   **Setting:** Enable and specify a secure, centralized network share for storing transcripts.
-   **Logging of Potentially Dangerous Commands:** Monitor for specific cmdlets often abused by adversaries (e.g., `Invoke-Mimikatz`, `Invoke-WebRequest`, `DownloadString`, `IEX`, `[System.Reflection.Assembly]::Load`).

**Note:** Ensure these logs are forwarded to your SIEM for centralized analysis, correlation, and long-term storage.
